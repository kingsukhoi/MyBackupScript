#!/bin/bash
set -ue

whereami="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# import backblaze keys from a file named .env
if [ ! -r "$whereami/.env" ] && [ ! -f "$whereami/.env" ]; then
	(>&2 echo 'enviroment file (.env) not found')
    exit 1
fi

source "$whereami/.env"

if [ "$#" -eq "2" ]; then
	if [ "$1" = "-f" ]; then 
		source "$2"
		exit $?
	fi
fi

if [ ! -d "$whereami/Scripts" ]; then
	echo $whereami/Scripts
    	(>&2 echo "Scripts directory not found.
Please run mkdir -p `dirname $0`/Scripts and add some scripts with the .sh extention")
    exit 1
fi

# everything in here should backup to a tmp directory specified in the env var below
export TEMP_DIR=/tmp/backup
for i in $whereami/Scripts/*.sh; do  

	echo "Running $i"
    if [ -r "$i" ]; then
        if [ "${-#*i}" != "$-" ]; then 
		echo "Running $i in first if"
    		. "$i"
        else
		echo "Running $i in second if"
		. "$i" 
        fi
    fi  
    
done

PathsToInclude=$(cat "$whereami/PathsToBackup" | xargs)
PathsToIgnore=$(cat "$whereami/PathsToIgnore" | xargs)

restic backup --exclude-caches --exclude "$PathsToIgnore" "$PathsToInclude" "$TEMP_DIR"

restic forget --prune --keep-weekly 5 --keep-monthly 6 --keep-yearly 100
restic check
